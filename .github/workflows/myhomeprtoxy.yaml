name: myHomeProxy

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git gettext lua5.1 liblua5.1-dev pkg-config

      - name: Build po2lmo from LuCI
        run: |
          # shallow clone LuCI, build po2lmo and install to /usr/local/bin
          git clone --depth 1 https://github.com/openwrt/luci.git /tmp/luci
          cd /tmp/luci/modules/luci-base/src || { echo "luci path not found"; exit 1; }
          make || { echo "po2lmo build failed"; exit 1; }
          sudo install -m 0755 po2lmo /usr/local/bin/po2lmo
          echo "po2lmo installed to $(command -v po2lmo)"
          /usr/local/bin/po2lmo --help || true

      - name: Run build-ipk.sh
        run: |
          chmod +x ./build-ipk.sh
          ./build-ipk.sh
